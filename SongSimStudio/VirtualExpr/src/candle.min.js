var scene=new THREE.Scene;var camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,1e3);camera.position.set(3,5,8).setLength(15);var renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(window.innerWidth,window.innerHeight);renderer.setClearColor(13421772);renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;document.body.appendChild(renderer.domElement);var labelRenderer=new CSS2DRenderer;labelRenderer.setSize(window.innerWidth,window.innerHeight);labelRenderer.domElement.style.position="absolute";labelRenderer.domElement.style.top="0px";document.body.appendChild(labelRenderer.domElement);var controls=new THREE.OrbitControls(camera,labelRenderer.domElement);controls.enablePan=true;var light=new THREE.DirectionalLight(16777215,1);light.position.setScalar(10);scene.add(light);scene.add(new THREE.AmbientLight(16777215,.5));{var path=new THREE.Path;path.moveTo(0,0);path.lineTo(1.9,0);path.lineTo(1.8,.3);path.lineTo(3.5,2.5);path.lineTo(1.5,3.8);path.lineTo(1.4,4.5);path.lineTo(0,4.5);var geometry=new THREE.LatheBufferGeometry(path.getPoints(),64);var material=new THREE.MeshPhongMaterial({color:"silver",transparent:true,opacity:.9});var bottle=new THREE.Mesh(geometry,material);scene.add(bottle);bottle.position.set(0,-3.6,0);bottle.castShadow=true}{var geometry=new THREE.CylinderGeometry(.05,.06,4.5,32);var material=new THREE.MeshLambertMaterial({color:"black"});var candlewick=new THREE.Mesh(geometry,material);scene.add(candlewick);candlewick.position.set(0,0,0)}{var geometry=new THREE.CylinderGeometry(1.2,1,1,32);var material=new THREE.MeshPhongMaterial({color:16753920});var plug=new THREE.Mesh(geometry,material);scene.add(plug);plug.position.set(0,.8,0)}{var geometry=new THREE.CylinderGeometry(3.4,1.6,2.2,32);var material=new THREE.MeshPhongMaterial({color:16711680});var alcohol=new THREE.Mesh(geometry,material);scene.add(alcohol);alcohol.position.set(0,-2.2,0)}{var candleLight=new THREE.PointLight(16755251,1,15,2);candleLight.position.set(0,3,0);candleLight.castShadow=true;scene.add(candleLight);var candleLight2=new THREE.PointLight(16755251,1,20,2);candleLight2.position.set(0,4,0);candleLight2.castShadow=true;scene.add(candleLight2)}{var flameMaterials=[];function addFlame(e){var t=new THREE.SphereBufferGeometry(.5,32,32);t.translate(0,.5,0);var a=getFlameMaterial(e);flameMaterials.push(a);var r=new THREE.Mesh(t,a);r.position.set(.06,1.2,.06);r.rotation.y=THREE.Math.degToRad(-45);scene.add(r)}addFlame(false);addFlame(true)}{var geometry=new THREE.BoxGeometry(25,.2,16);geometry.translate(0,-.25,0);var material=new THREE.MeshPhongMaterial({map:(new THREE.TextureLoader).load("img/hardwood2_diffuse.jpg")});var table=new THREE.Mesh(geometry,material);table.receiveShadow=true;table.position.set(0,-3.5,0);scene.add(table)}{var geometry=new THREE.CylinderGeometry(2,2,2,32);var material=new THREE.MeshPhongMaterial({color:4491519,transparent:true,opacity:.3});var wrapper=new THREE.Mesh(geometry,material);scene.add(wrapper);wrapper.position.set(0,5.5,0)}{var geometry=new THREE.CylinderGeometry(1.9,1.9,1.2,32);var material=new THREE.MeshPhongMaterial({color:"blue",transparent:true,opacity:.8});var water=new THREE.Mesh(geometry,material);scene.add(water);water.position.set(0,5.2,0)}{var geometry=new THREE.TorusGeometry(2.05,.1,16,100);var material=new THREE.MeshLambertMaterial({color:"black"});var torus=new THREE.Mesh(geometry,material);scene.add(torus);torus.position.set(0,5.2,0);torus.rotation.x+=Math.PI/2}{var geometry=new THREE.CylinderGeometry(.1,.1,10,32);var material=new THREE.MeshLambertMaterial({color:"black"});var holder=new THREE.Mesh(geometry,material);scene.add(holder);holder.position.set(4,1,0);holder.castShadow=true}{var geometry=new THREE.CylinderGeometry(1.1,1.1,.15,32);var material=new THREE.MeshLambertMaterial({color:"black"});var holder=new THREE.Mesh(geometry,material);scene.add(holder);holder.position.set(4,-3.5,0)}{var geometry=new THREE.CylinderGeometry(.1,.1,3,32);var material=new THREE.MeshLambertMaterial({color:"black"});var holder=new THREE.Mesh(geometry,material);scene.add(holder);holder.rotation.z+=Math.PI/2;holder.position.set(3.5,5.2,0)}var myChart,chartOption,chartMaterial;{var myCanvas=document.createElement("canvas");myCanvas.setAttribute("width",512);myCanvas.setAttribute("height",512);myChart=echarts.init(myCanvas);chartOption={tooltip:{formatter:"{a} <br/>{c} {b}"},toolbox:{show:true,feature:{restore:{show:false},saveAsImage:{show:false}}},series:[{name:"温度计",type:"gauge",center:["62%","50%"],z:3,min:0,max:220,splitNumber:11,radius:"50%",axisLine:{lineStyle:{width:10}},axisTick:{length:15,lineStyle:{color:"auto"}},splitLine:{length:20,lineStyle:{color:"auto"}},axisLabel:{backgroundColor:"auto",borderRadius:2,color:"#eee",padding:3,textShadowBlur:2,textShadowOffsetX:1,textShadowOffsetY:1,textShadowColor:"#222"},title:{fontWeight:"bolder",fontSize:20,fontStyle:"italic"},detail:{formatter:function(e){e=(e+"").split(".");e.length<2&&e.push("00");return("00"+e[0]).slice(-3)+"."+(e[1]+"00").slice(0,1)},fontWeight:"bolder",borderRadius:3,backgroundColor:"#444",borderColor:"#aaa",shadowBlur:5,shadowColor:"#333",shadowOffsetX:0,shadowOffsetY:3,borderWidth:2,textBorderColor:"#000",textBorderWidth:2,textShadowBlur:2,textShadowColor:"#fff",textShadowOffsetX:0,textShadowOffsetY:0,fontFamily:"Arial",width:120,color:"#eee",rich:{}},data:[{value:30,name:"°C"}]},{name:"压力",type:"gauge",center:["28%","50%"],radius:"35%",min:0,max:7,endAngle:45,splitNumber:7,axisLine:{lineStyle:{width:8}},axisTick:{length:12,lineStyle:{color:"auto"}},splitLine:{length:20,lineStyle:{color:"auto"}},pointer:{width:5},title:{offsetCenter:[0,"-30%"]},detail:{fontWeight:"bolder"},data:[{value:.1,name:"atm"}]}]};myChart.setOption(chartOption,true);myChart.on("finished",function(){var e=new THREE.CanvasTexture(myCanvas);chartMaterial=new THREE.MeshBasicMaterial({color:"gray",map:e});var t=new THREE.PlaneGeometry(512,512);var a=new THREE.Mesh(t,chartMaterial);a.position.set(-6.5,0,-3.5);a.scale.set(.02,.02,.02);a.rotation.x-=Math.PI/15;scene.add(a)})}console.log("chartMaterial",chartMaterial);{var geometry=new THREE.BoxGeometry(12,1.5,10);var material=new THREE.MeshBasicMaterial({color:"gray"});var meter=new THREE.Mesh(geometry,material);meter.position.set(-6.5,.5,-4.5);meter.rotation.x=Math.PI/2-Math.PI/15;scene.add(meter)}{var curve=new THREE.CatmullRomCurve3([new THREE.Vector3(0,6,0),new THREE.Vector3(0,7.2,0),new THREE.Vector3(0,7.5,-1),new THREE.Vector3(0,7.5,-3),new THREE.Vector3(0,7.2,-5),new THREE.Vector3(0,4.5,-5),new THREE.Vector3(-2,2.5,-4.5)],false);var channel=new WaterPipe(curve,.06,.1,false,null,"purple",false);scene.add(channel.obj)}var switchs=[];{var switchGrp=new THREE.Group;switchs[0]=new ToggleButton("Switch0",false);switchs[0].obj.position.set(-12,4,-3.5);switchs[0].obj.scale.set(.05,.05,.05);switchGrp.add(switchs[0].obj);createTag("1atm",10,switchs[0].obj);switchs[1]=new ToggleButton("Switch1",true);switchs[1].obj.position.set(-12,2,-3.5);switchs[1].obj.scale.set(.05,.05,.05);switchGrp.add(switchs[1].obj);createTag("2atm",10,switchs[1].obj);switchs[2]=new ToggleButton("Switch2",true);switchs[2].obj.position.set(-12,0,-3.5);switchs[2].obj.scale.set(.05,.05,.05);switchGrp.add(switchs[2].obj);createTag("5atm",10,switchs[2].obj);switchs[3]=new ToggleButton("Switch3",true);switchs[3].obj.position.set(-12,-2,-3.5);switchs[3].obj.scale.set(.05,.05,.05);switchGrp.add(switchs[3].obj);createTag("8atm",10,switchs[3].obj);scene.add(switchGrp);switchGrp.rotation.x=-Math.PI/15}var selectedObject=null;var raycaster=new THREE.Raycaster;var mouseVector=new THREE.Vector3;window.addEventListener("click",onMouseClick,false);function onMouseClick(e){console.log("RayCast fired!");e.preventDefault();if(selectedObject){selectedObject=null}var t=getIntersects(e.layerX,e.layerY);if(t.length>0){var a=t.filter(function(e){return e&&e.object})[0];if(a&&a.object){selectedObject=a.object;buttonProcesser(selectedObject)}}}function getIntersects(e,t){e=e/window.innerWidth*2-1;t=-(t/window.innerHeight)*2+1;mouseVector.set(e,t,.5);raycaster.setFromCamera(mouseVector,camera);return raycaster.intersectObject(switchGrp,true)}var boiling=false;function updateChart(a,r,o){var i=1;var e=function(){var e=a+(r-a)*i/10;var t=100*Math.sqrt(Math.sqrt(e-0));console.log("Current Pressure/Temperature:",e,t);chartOption.series[0].data[0].value=t.toFixed(1)-0;chartOption.series[1].data[0].value=e.toFixed(1)-0;myChart.setOption(chartOption,true);chartMaterial.needsUpdate=true;if(i>3){boiling=true;bubbleGrp.position.y=0;if(o){camera.position.z=1234;alert("容器压力严重超载，设备已爆炸损坏！");return}}i++};var t=setInterval(e,2e3);var n=function(){clearInterval(t);boiling=false;bubbleGrp.position.y=-1e3};setTimeout(n,2e3*10)}var Plist=[1,2,5,8];var currentP=.1,targetP=.1;function buttonProcesser(e){var t=e.name,a;if(t.substr(0,6)=="Switch"){a=parseInt(t.substr(6,1));console.info("switchID->",a," is selected!");for(var r=0;r<4;r++){if(r==a){switchs[r].toggle();currentP=targetP;targetP=Plist[r];var o=r==3?true:false;updateChart(currentP,targetP,o)}else{switchs[r].open(false)}}}}var totalBubble=20;var bubbles=[];var bubbleGrp=new THREE.Group;{var textureLoader=new THREE.TextureLoader;var mapB=textureLoader.load("img/bubble.png");var material=new THREE.SpriteMaterial({map:mapB,color:16777215,fog:true});material.color.setHSL(1,1,1);for(var i=0;i<totalBubble;i++){bubbles[i]=new THREE.Sprite(material);var R=.2+1.3*Math.random();var theta=Math.random()*Math.PI*2;bubbles[i].position.x=R*Math.cos(theta);bubbles[i].position.y=4.8+Math.random()*.6;bubbles[i].position.z=R*Math.sin(theta);bubbles[i].scale.multiplyScalar(Math.random()*.2+.1);bubbleGrp.add(bubbles[i])}scene.add(bubbleGrp);bubbleGrp.position.y=-1e3}var clock=new THREE.Clock;var time=0;render();function render(){requestAnimationFrame(render);time+=clock.getDelta();flameMaterials[0].uniforms.time.value=time;flameMaterials[1].uniforms.time.value=time;candleLight2.position.x=Math.sin(time*Math.PI)*.25;candleLight2.position.z=Math.cos(time*Math.PI*.75)*.25;candleLight2.intensity=2+Math.sin(time*Math.PI*2)*Math.cos(time*Math.PI*1.5)*.25;if(boiling){for(var e=0;e<totalBubble;e++){if(bubbles[e].position.y>5.5){var t=.2+1.3*Math.random();var a=Math.random()*Math.PI*2;bubbles[e].position.x=t*Math.cos(a);bubbles[e].position.y=4.8+Math.random()*.6;bubbles[e].position.z=t*Math.sin(a)}else{bubbles[e].position.y+=.05}}}renderer.render(scene,camera);labelRenderer.render(scene,camera)}