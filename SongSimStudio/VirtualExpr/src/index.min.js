var scene=new THREE.Scene;var flowTexture,curve,curves=[],flows=[],buoy;var camera,renderer,labelRenderer;var progress=0;var startExperiment=false;var inFlowFull=false;var BernoulliFlow=false;var outFlowFull=false;var waterTank,valveOut,valveIn,inflow,outflow,waterBin;var selectedObject=null;var pumpSwitch,pump,fan,groupMisc;var raycaster=new THREE.Raycaster;var mouseVector=new THREE.Vector3;var latestMouseProjection;var resultTag;var channels=[],pTubes=[],props=[];var numExpr=7;var labName=["能量守恒","沿程阻力","局部阻力","毕托管","阀门","文丘里","雷诺"];var results=["流速1.1m/s,测压管读数:10cm,20cm,10cm","流速1.2m/s,测压管读数:12cm,10cm","流速0.8m/s,测压管读数:206mm,281mcm,263mm","测压管读数:15cm,12cm","流速1.0m/s,测压管读数:208mm,282mcm,264mm","测压管读数:16cm,14.5cm","流速1.1m/s"];groupMisc=new THREE.Group;scene.add(groupMisc);var labID=0;var speeds=[.5,1,1.5];var speed=speeds[1];var workPlaneZ=20;var pTubePlaneZ=10;var hiddenPlaneZ=-1e5;addLights();addCameras();addSpriteButtons();addMisc();loadTexture();addWaterPipe();addWaterPointer();addWorkSpace();addDesktop();addMeters();addControllers();loadModels();render();function render(){renderer.render(scene,camera);labelRenderer.render(scene,camera);requestAnimationFrame(render);if(startExperiment){inflow.obj.position.z=workPlaneZ;inflow.stepForward();pump.rotation.z-=.1;fan.rotation.z+=.05}else{inflow.obj.position.z=hiddenPlaneZ;inflow.reset();inFlowFull=false;BernoulliFlow=false;resultTag.textContent="开启电源水箱水位满后才有数据"}if(inFlowFull){waterTank.stepForward()}else{waterTank.stepBackward()}if(BernoulliFlow){pTubes[0].stepForward();pTubes[1].stepForward();pTubes[2].stepForward();outflow.stepForward()}else{pTubes[0].stepBackward();pTubes[1].stepBackward();pTubes[2].stepBackward();outflow.reset();outFlowFull=false}if(BernoulliFlow){flowTexture.offset.x-=.06*speed;if(progress>1){progress=0}progress+=9e-4*speed;if(curve){var e=curve.getPoint(progress);if(e&&e.x){buoy.position.set(e.x,e.y,e.z)}}}if(outFlowFull){waterBin.stepForward()}else{waterBin.stepBackward()}}function addWorkSpace(){waterTank=new WaterTank(50,160,40,1,45,145,.2,true,null,true,"tankHalf","tankFull");scene.add(waterTank.obj);waterTank.obj.castShadow=true;waterTank.obj.position.set(-145,-60,20);waterTank.addEventListener(waterTank.fullEventName,function(){console.info("Water Tank Full！");resultTag.textContent=results[labID]});waterTank.addEventListener(waterTank.halfEventName,function(){BernoulliFlow=true;console.info("Water Tank Half！")});waterBin=new WaterTank(50,30,40,1,5,20,.05,true,null,true,"binHalf","binFull");scene.add(waterBin.obj);waterBin.obj.position.set(125,-60,20);var e=new WaterTank(50,50,40,10,20,30,.005,false,"blue",true,"bba","aaab");scene.add(e.obj);e.obj.position.set(-135,-125,20);pTubes[0]=new PressureTube(1,2,2,80,.015,.5,true,"tube1Full");scene.add(pTubes[0].obj);pTubes[0].obj.position.set(-75,-15,pTubePlaneZ);pTubes[1]=new PressureTube(1,2,2,80,.075,.8,true,"tube2Full");scene.add(pTubes[1].obj);pTubes[1].obj.position.set(0,-15,pTubePlaneZ);pTubes[2]=new PressureTube(1,1.5,2,80,.015,.5,true,"tube3Full");scene.add(pTubes[2].obj);pTubes[2].obj.position.set(75,-15,pTubePlaneZ);valveOut=new Valve(0,0,10,5,.7);scene.add(valveOut.obj);valveOut.obj.position.set(121,-15,12);valveIn=new Valve(0,0,10,5,.7);scene.add(valveIn.obj);valveIn.obj.position.set(-155,125,13);inflow=new PressureTube(2,4,1,165,.5,1,false,"inflowFull");scene.add(inflow.obj);inflow.obj.position.set(-145,110,workPlaneZ);inflow.obj.rotation.z+=Math.PI;inflow.addEventListener(inflow.fullEventName,function(){inFlowFull=true;console.info("inflow Water Tube Full！")});outflow=new PressureTube(2,4,1,30,.5,1,false,"outFlowFull");scene.add(outflow.obj);outflow.obj.position.set(121,-25,20);outflow.obj.rotation.z+=Math.PI;outflow.addEventListener(outflow.fullEventName,function(){outFlowFull=true;console.info("outflow Water Tube Full！")});var a=new THREE.CatmullRomCurve3([new THREE.Vector3(-135,-125,20),new THREE.Vector3(-120,-95,20),new THREE.Vector3(-100,-85,20),new THREE.Vector3(100,-85,20),new THREE.Vector3(120,-75,20),new THREE.Vector3(135,-65,20)],false);var r=new WaterPipe(a,.6,2,false,null,"black",false);scene.add(r.obj);var n=new THREE.CatmullRomCurve3([new THREE.Vector3(-155,-120,20),new THREE.Vector3(-175,-110,20),new THREE.Vector3(-185,-100,20),new THREE.Vector3(-190,0,20),new THREE.Vector3(-185,110,20),new THREE.Vector3(-175,125,20),new THREE.Vector3(-155,125,20),new THREE.Vector3(-145,120,20),new THREE.Vector3(-145,115,20),new THREE.Vector3(-145,110,20)],false);var o=new WaterPipe(n,.6,3,false,null,"black",false);scene.add(o.obj);var t=new THREE.CatmullRomCurve3([new THREE.Vector3(-75,-14,pTubePlaneZ),new THREE.Vector3(-75,-20,(pTubePlaneZ+workPlaneZ)/2),new THREE.Vector3(-75,-15,workPlaneZ)],false);channels[0]=new WaterPipe(t,.6,1,false,null,"purple",false);scene.add(channels[0].obj);var l=new THREE.CatmullRomCurve3([new THREE.Vector3(0,-14,pTubePlaneZ),new THREE.Vector3(0,-20,(pTubePlaneZ+workPlaneZ)/2),new THREE.Vector3(0,-15,workPlaneZ)],false);channels[1]=new WaterPipe(l,.6,1,false,null,"purple",false);scene.add(channels[1].obj);channels[1].obj.position.z=hiddenPlaneZ;var s=new THREE.CatmullRomCurve3([new THREE.Vector3(75,-14,pTubePlaneZ),new THREE.Vector3(75,-20,(pTubePlaneZ+workPlaneZ)/2),new THREE.Vector3(75,-15,workPlaneZ)],false);channels[2]=new WaterPipe(s,.6,1,false,null,"purple",false);scene.add(channels[2].obj);var i=new THREE.CatmullRomCurve3([new THREE.Vector3(0,-14,pTubePlaneZ),new THREE.Vector3(0,-45,pTubePlaneZ),new THREE.Vector3(0,-60,workPlaneZ),new THREE.Vector3(0,-63,workPlaneZ)],false);channels[3]=new WaterPipe(i,.6,1,false,null,"purple",false);scene.add(channels[3].obj);var u=new THREE.CatmullRomCurve3([new THREE.Vector3(75,-14,pTubePlaneZ),new THREE.Vector3(70,-18,pTubePlaneZ),new THREE.Vector3(35,-40,pTubePlaneZ/2+workPlaneZ/2),new THREE.Vector3(2,-28,workPlaneZ),new THREE.Vector3(0,-25,workPlaneZ)],false);channels[4]=new WaterPipe(u,.6,1,false,null,"purple",false);scene.add(channels[4].obj);channels[4].obj.position.z=hiddenPlaneZ;var c=new THREE.CatmullRomCurve3([new THREE.Vector3(75,-14,pTubePlaneZ),new THREE.Vector3(70,-18,pTubePlaneZ),new THREE.Vector3(40,-40,pTubePlaneZ/2+workPlaneZ/2),new THREE.Vector3(11,-22,workPlaneZ),new THREE.Vector3(10,-20,workPlaneZ)],false);channels[5]=new WaterPipe(c,.6,1,false,null,"purple",false);scene.add(channels[5].obj);channels[5].obj.position.z=hiddenPlaneZ}function addWaterPipe(){curves[0]=new THREE.CatmullRomCurve3([new THREE.Vector3(-120,-15,workPlaneZ),new THREE.Vector3(-80,-15,workPlaneZ),new THREE.Vector3(-60,-15,workPlaneZ),new THREE.Vector3(-40,-21,workPlaneZ),new THREE.Vector3(-30,-55,workPlaneZ),new THREE.Vector3(40,-55,workPlaneZ),new THREE.Vector3(50,-21,workPlaneZ),new THREE.Vector3(80,-15,workPlaneZ),new THREE.Vector3(120,-15,workPlaneZ),new THREE.Vector3(121,-25,workPlaneZ)],false);flows[0]=new WaterPipe(curves[0],2,4,true,flowTexture,"black",true);scene.add(flows[0].obj);curve=curves[0];curves[1]=new THREE.CatmullRomCurve3([new THREE.Vector3(-120,-15,workPlaneZ),new THREE.Vector3(100,-15,workPlaneZ),new THREE.Vector3(120,-15,workPlaneZ),new THREE.Vector3(121,-25,workPlaneZ)],false);flows[1]=new WaterPipe(curves[1],2,4,true,flowTexture,"black",true);flows[1].obj.position.z=hiddenPlaneZ;scene.add(flows[1].obj);curves[2]=curves[1];var e=new THREE.CatmullRomCurve3([new THREE.Vector3(0,0,0),new THREE.Vector3(0,225,0),new THREE.Vector3(0,240,0),new THREE.Vector3(5,240,0)],false);flows[2]=new ExpandablePipe(e,1.2,2,241,true,flowTexture,"black",true);flows[2].obj.position.set(-120,-15,hiddenPlaneZ);flows[2].obj.rotation.z-=Math.PI/2;scene.add(flows[2].obj);curves[3]=curves[1];curves[4]=curves[1];curves[5]=curves[1];curves[6]=curves[1];flows[3]=flows[1];flows[4]=flows[1];flows[5]=flows[1];flows[6]=flows[1]}function addWaterPointer(){var e=new THREE.SphereGeometry(5,16,16);var a=new THREE.MeshBasicMaterial({color:65280,side:THREE.DoubleSide});buoy=new THREE.Mesh(e,a);buoy.castShadow=true;scene.add(buoy);buoy.position.set(121,-25,20)}function addDesktop(){{var e=new THREE.PlaneGeometry(350,150);var a=new THREE.MeshLambertMaterial({color:13421772,side:THREE.DoubleSide});a.map=(new THREE.TextureLoader).load("img/BBoard.jpg");var r=new THREE.Mesh(e,a);r.position.set(0,-4,-14);r.receiveShadow=true;scene.add(r);resultTag=createTag("实验数据",10,r)}{var e=new THREE.PlaneGeometry(350,80);var a=new THREE.MeshLambertMaterial({color:6710886,side:THREE.DoubleSide});a.map=(new THREE.TextureLoader).load("img/desktop.jpg");var n=new THREE.Mesh(e,a);n.position.set(0,-72,20);n.rotation.x=Math.PI/2;n.receiveShadow=true;scene.add(n)}pumpSwitch=new ToggleButton("pumpSwitch");pumpSwitch.obj.position.set(150,50,0);pumpSwitch.obj.userData.tooltipText="PowerSupply";groupMisc.add(pumpSwitch.obj);createTag("电源",10,pumpSwitch.obj);pump=new FanBase(5,20,10,Math.PI/2,6,4,"red").obj;pump.position.set(-135,-105,20);scene.add(pump);createTag("潜水泵",10,pump);var o=new THREE.CylinderGeometry(5,5,10,32);var t=new THREE.MeshBasicMaterial({color:16776960});var l=new THREE.Mesh(o,t);l.rotation.x=Math.PI/2;l.position.set(-135,-105,20);scene.add(l);fan=new FanBase(5,20,10,0,5,2).obj;fan.scale.set(2,2,2);fan.position.set(0,0,5);fan.castShadow=true}function addMeters(){return;var o=$("<canvas width='512' height='512'></canvas>")[0];var t=echarts.init(o);var l={tooltip:{formatter:"{a} <br/>{b} : {c}%"},backgroundColor:"#FFFFFF",series:[{name:"压力",type:"gauge",detail:{formatter:"{value}MPa"},data:[{value:50,name:"鸭梨"}]}]};t.setOption(l,true);t.on("finished",function(){var e=new THREE.CanvasTexture(o);var a=new THREE.MeshBasicMaterial({transparent:true,map:e,side:THREE.DoubleSide});var r=new THREE.PlaneGeometry(80,80);var n=new THREE.Mesh(r,a);n.position.set(0,112,-14);scene.add(n);setInterval(function(){a.needsUpdate=true;l.series[0].data[0].value=(Math.random()*100).toFixed(2)-0;t.setOption(l,true)},2e3)})}function loadTexture(){var e=new THREE.TextureLoader;flowTexture=e.load("img/flowLike.png");flowTexture.wrapS=THREE.RepeatWrapping;flowTexture.wrapT=THREE.RepeatWrapping;flowTexture.repeat.x=20}function onMouseClick(e){console.log("RayCast fired!");e.preventDefault();if(selectedObject){selectedObject=null;latestMouseProjection=null}var a=getIntersects(e.layerX,e.layerY);if(a.length>0){var r=a.filter(function(e){return e&&e.object})[0];if(r&&r.object){selectedObject=r.object;latestMouseProjection=r.point;buttonProcesser(selectedObject)}}}function getIntersects(e,a){e=e/window.innerWidth*2-1;a=-(a/window.innerHeight)*2+1;mouseVector.set(e,a,.5);raycaster.setFromCamera(mouseVector,camera);return raycaster.intersectObject(groupMisc,true)}var propMatrix=[];propMatrix[0]=[0,0,0];propMatrix[1]=[0,0,0];propMatrix[2]=[0,0,0];propMatrix[3]=[1,0,0];propMatrix[4]=[0,0,1];propMatrix[5]=[0,1,0];propMatrix[6]=[0,0,0];var pTubeMatrix=[];pTubeMatrix[0]=[1,1,1];pTubeMatrix[1]=[1,0,1];pTubeMatrix[2]=[1,1,1];pTubeMatrix[3]=[0,1,1];pTubeMatrix[4]=[1,1,1];pTubeMatrix[5]=[0,1,1];pTubeMatrix[6]=[0,0,0];var channelMatrix=[];channelMatrix[0]=[1,0,1,1,0,0];channelMatrix[1]=[1,0,1,0,0,0];channelMatrix[2]=[1,1,1,0,0,0];channelMatrix[3]=[0,1,0,0,1,0];channelMatrix[4]=[1,1,1,0,0,0];channelMatrix[5]=[0,1,0,0,0,1];channelMatrix[6]=[0,0,0,0,0,0];function buttonProcesser(e){var a=e.name,r,n;if(a=="pumpSwitch"){if(pumpSwitch.toggle()){valveIn.open();startExperiment=true}else{valveIn.close();startExperiment=false}}if(a.substr(0,3)=="lab"){r=parseInt(a.substr(3,1));curve=curves[r];console.info("labID->",r," is selected!");for(var o=0;o<3;o++){if(o==r){flows[o].obj.position.z=0}else{flows[o].obj.position.z=hiddenPlaneZ}}if(r>2){flows[1].obj.position.z=0}for(var o=0;o<3;o++){props[o].position.z=propMatrix[r][o]?workPlaneZ:hiddenPlaneZ}for(var o=0;o<3;o++){pTubes[o].obj.position.z=pTubeMatrix[r][o]?pTubePlaneZ:hiddenPlaneZ}for(var o=0;o<6;o++){channels[o].obj.position.z=channelMatrix[r][o]?0:hiddenPlaneZ}resultTag.textContent=results[r]}if(a.substr(0,3)=="spd"){n=parseInt(a.substr(3,1));speed=speeds[n];console.info("speed->",speed," is selected!")}}function addLights(){var e=new THREE.DirectionalLight(16777215,.5);e.castShadow=true;e.position.set(0,80,80);e.shadow.camera.near=20;e.shadow.camera.far=200;e.shadow.camera.left=-200;e.shadow.camera.right=200;e.shadow.camera.top=200;e.shadow.camera.bottom=-80;scene.add(e);var a=new THREE.AmbientLight(8947848);scene.add(a)}function addCameras(){var e=window.innerWidth;var a=window.innerHeight;var r=e/a;var n=100;camera=new THREE.OrthographicCamera(-n*r,n*r,n,-n,1,3e3);camera.position.set(200,300,200);console.log("scene.position=",scene.position);camera.lookAt(scene.position);renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(e,a);renderer.setClearColor(12178431,1);renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.BasicShadowMap;document.body.appendChild(renderer.domElement);labelRenderer=new CSS2DRenderer;labelRenderer.setSize(window.innerWidth,window.innerHeight);labelRenderer.domElement.style.position="absolute";labelRenderer.domElement.style.top="0px";document.body.appendChild(labelRenderer.domElement)}function addMisc(){window.addEventListener("click",onMouseClick,false)}function addSpriteButtons(){for(var e=0;e<7;e++){var a=TextSprite({width:128,height:64,color:11468799},labName[e]);a.position.set(e*32-88,45,2);a.scale.set(28,14,1);a.name="lab"+e;a.userData.tooltipText="lab"+e;groupMisc.add(a)}var r=["慢速","中速","快速"];for(var e=0;e<3;e++){var a=TextSprite({width:128,height:64,color:11424767},r[e]);a.position.set(135+e*15,20,2);a.scale.set(32,16,1);a.name="spd"+e;a.userData.tooltipText=r[e];groupMisc.add(a)}}function addControllers(){var e=new THREE.OrbitControls(camera,labelRenderer.domElement)}var manager=new THREE.LoadingManager;manager.addHandler(/\.dds$/i,new DDSLoader);function onProgress(e){if(e.lengthComputable){var a=e.loaded/e.total*100;console.log("model "+Math.round(a,2)+"% downloaded")}}function onError(){}function loadModels(){new MTLLoader(manager).setPath("models/").load("glass.mtl",function(e){e.preload();console.log("materials:",e);new OBJLoader(manager).setMaterials(e).setPath("models/").load("Pitot-Tube.obj",function(e){e.rotation.y+=-Math.PI/2;e.rotation.x+=Math.PI/2;e.scale.set(.05,.05,.05);e.position.set(-7,-15,hiddenPlaneZ);e.castShadow=true;scene.add(e);props[0]=e},onProgress,onError);new OBJLoader(manager).setMaterials(e).setPath("models/").load("Venturi.obj",function(e){e.scale.set(.125,.125,.125);e.rotation.x+=Math.PI;e.position.set(15,-15,hiddenPlaneZ);e.castShadow=true;scene.add(e);props[1]=e},onProgress,onError);new OBJLoader(manager).setMaterials(e).setPath("models/").load("GateValve.obj",function(e){e.scale.set(.25,.25,.25);e.position.set(-75,-15,hiddenPlaneZ);e.rotation.x+=Math.PI/2;e.castShadow=true;scene.add(e);props[2]=e},onProgress,onError)})}function onWindowResize(){var e=window.innerWidth;var a=window.innerHeight;camera.aspect=e/a;camera.updateProjectionMatrix();renderer.setSize(e,a);render()}